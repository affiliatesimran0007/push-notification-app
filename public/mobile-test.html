<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2196f3">
    <title>Push Notifications - Mobile Test</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-icon {
            font-size: 60px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .status-message {
            text-align: center;
            font-size: 18px;
            margin-bottom: 30px;
        }
        
        .button {
            display: block;
            width: 100%;
            padding: 18px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .button:active {
            transform: scale(0.98);
        }
        
        .button:disabled {
            background: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            cursor: not-allowed;
        }
        
        .button.secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }
        
        .device-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .device-info h3 {
            margin-bottom: 10px;
        }
        
        .device-info p {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .device-info span {
            font-weight: 600;
        }
        
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        
        .test-section {
            margin-top: 20px;
        }
        
        .test-button {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .test-button:active {
            background: rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 380px) {
            body {
                padding: 15px;
            }
            .header h1 {
                font-size: 24px;
            }
            .button {
                font-size: 16px;
                padding: 15px;
            }
        }
        
        /* iOS specific styles */
        @supports (-webkit-touch-callout: none) {
            .card {
                -webkit-backdrop-filter: blur(10px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîî Push Notifications</h1>
            <p>Mobile Device Test</p>
        </div>
        
        <div class="card">
            <div class="status-icon" id="statusIcon">üì±</div>
            <div class="status-message" id="statusMessage">Checking device...</div>
            
            <button class="button" id="enableBtn" onclick="enableNotifications()" style="display: none;">
                Enable Push Notifications
            </button>
            
            <button class="button secondary" id="testBtn" onclick="sendTestNotification()" style="display: none;">
                Send Test Notification
            </button>
        </div>
        
        <div class="card device-info">
            <h3>Device Information</h3>
            <p>Platform: <span id="platform">-</span></p>
            <p>Browser: <span id="browser">-</span></p>
            <p>OS: <span id="os">-</span></p>
            <p>Screen: <span id="screen">-</span></p>
            <p>Notification Support: <span id="notifSupport">-</span></p>
            <p>Service Worker: <span id="swSupport">-</span></p>
            <p>Permission: <span id="permission">-</span></p>
        </div>
        
        <div class="card test-section">
            <h3>Quick Tests</h3>
            <div class="test-button" onclick="testVibration()">
                üì≥ Test Vibration
            </div>
            <div class="test-button" onclick="testLocalNotification()">
                üí¨ Test Local Notification
            </div>
            <div class="test-button" onclick="checkInstallability()">
                üì≤ Check PWA Install Status
            </div>
        </div>
    </div>

    <script>
        const VAPID_KEY = 'BNV70f-uHInqVEOT9r2d6pVfK5WViCXdtoYjB87Nf8WUQZ6mDMSXEXGFQmJXl6bvGpvzL2jVSuPZUk-S9YS8rYc';
        let currentSubscription = null;
        
        // Device detection
        function detectDevice() {
            const ua = navigator.userAgent;
            const platform = navigator.platform;
            
            let browser = 'Unknown';
            let os = 'Unknown';
            let deviceType = 'Desktop';
            
            // Browser detection
            if (ua.includes('Chrome') && !ua.includes('Edg')) browser = 'Chrome';
            else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Edg')) browser = 'Edge';
            else if (ua.includes('Samsung')) browser = 'Samsung Internet';
            
            // OS detection
            if (ua.includes('iPhone') || ua.includes('iPad')) {
                os = 'iOS';
                deviceType = ua.includes('iPad') ? 'iPad' : 'iPhone';
            } else if (ua.includes('Android')) {
                os = 'Android';
                deviceType = ua.includes('Mobile') ? 'Phone' : 'Tablet';
            } else if (ua.includes('Mac')) {
                os = 'macOS';
            } else if (ua.includes('Win')) {
                os = 'Windows';
            }
            
            // Update UI
            document.getElementById('platform').textContent = platform;
            document.getElementById('browser').textContent = browser;
            document.getElementById('os').textContent = `${os} (${deviceType})`;
            document.getElementById('screen').textContent = `${screen.width}x${screen.height}`;
            
            // Feature detection
            document.getElementById('notifSupport').textContent = 
                'Notification' in window ? '‚úÖ Yes' : '‚ùå No';
            document.getElementById('swSupport').textContent = 
                'serviceWorker' in navigator ? '‚úÖ Yes' : '‚ùå No';
            document.getElementById('permission').textContent = 
                'Notification' in window ? Notification.permission : 'N/A';
            
            return { browser, os, deviceType };
        }
        
        async function checkStatus() {
            const device = detectDevice();
            
            if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                updateStatus('‚ùå', 'Push notifications not supported', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                await navigator.serviceWorker.ready;
                
                const subscription = await registration.pushManager.getSubscription();
                const permission = Notification.permission;
                
                document.getElementById('permission').textContent = permission;
                
                if (subscription) {
                    currentSubscription = subscription;
                    updateStatus('‚úÖ', 'Push notifications enabled!', 'success');
                    document.getElementById('testBtn').style.display = 'block';
                } else if (permission === 'denied') {
                    updateStatus('üö´', 'Notifications blocked', 'error');
                    
                    // iOS specific message
                    if (device.os === 'iOS') {
                        updateStatus('üì±', 'Please add to Home Screen first', 'warning');
                    }
                } else {
                    updateStatus('üîî', 'Ready to enable notifications', 'info');
                    document.getElementById('enableBtn').style.display = 'block';
                }
            } catch (error) {
                console.error('Status check error:', error);
                updateStatus('‚ö†Ô∏è', 'Error checking status', 'error');
            }
        }
        
        function updateStatus(icon, message, type = 'info') {
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusMessage').textContent = message;
            document.getElementById('statusMessage').className = `status-message ${type}`;
        }
        
        async function enableNotifications() {
            try {
                document.getElementById('enableBtn').disabled = true;
                updateStatus('‚è≥', 'Requesting permission...', 'info');
                
                const permission = await Notification.requestPermission();
                
                if (permission !== 'granted') {
                    throw new Error('Permission denied');
                }
                
                updateStatus('üîÑ', 'Subscribing...', 'info');
                
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_KEY)
                });
                
                // Send to server
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription: subscription.toJSON(),
                        landingId: 'mobile-test',
                        url: window.location.href,
                        browserInfo: {
                            userAgent: navigator.userAgent,
                            language: navigator.language,
                            platform: navigator.platform
                        }
                    })
                });
                
                if (!response.ok) throw new Error('Server error');
                
                currentSubscription = subscription;
                document.getElementById('enableBtn').style.display = 'none';
                document.getElementById('testBtn').style.display = 'block';
                
                updateStatus('‚úÖ', 'Successfully enabled!', 'success');
                
                // Vibrate on success
                if ('vibrate' in navigator) {
                    navigator.vibrate(200);
                }
                
            } catch (error) {
                console.error('Enable error:', error);
                updateStatus('‚ùå', error.message, 'error');
            } finally {
                document.getElementById('enableBtn').disabled = false;
            }
        }
        
        async function sendTestNotification() {
            if (!currentSubscription) {
                updateStatus('‚ö†Ô∏è', 'No subscription found', 'warning');
                return;
            }
            
            try {
                updateStatus('üì§', 'Sending test...', 'info');
                
                const response = await fetch('/api/test-push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription: currentSubscription.toJSON()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('üì¨', 'Test sent! Check notifications', 'success');
                } else {
                    throw new Error(result.error || 'Failed to send');
                }
            } catch (error) {
                updateStatus('‚ùå', error.message, 'error');
            }
        }
        
        function testVibration() {
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
                alert('Vibration supported! Did you feel it?');
            } else {
                alert('Vibration not supported on this device');
            }
        }
        
        function testLocalNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Local Test', {
                    body: 'This is a local notification test',
                    icon: '/icon-192x192.png',
                    badge: '/badge-72x72.png'
                });
            } else {
                alert('Please enable notifications first');
            }
        }
        
        function checkInstallability() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                                window.navigator.standalone ||
                                document.referrer.includes('android-app://');
            
            if (isStandalone) {
                alert('‚úÖ App is installed/running in standalone mode!');
            } else {
                alert('üì± App is running in browser. For best experience on iOS, add to Home Screen!');
            }
        }
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            checkStatus();
            
            // Re-check when page becomes visible (iOS)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    document.getElementById('permission').textContent = 
                        'Notification' in window ? Notification.permission : 'N/A';
                }
            });
        });
        
        // iOS standalone mode detection
        if (window.navigator.standalone) {
            document.body.style.paddingTop = '20px'; // Account for status bar
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Detailed Push Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .warning { color: #f57c00; font-weight: bold; }
        .info { color: #1976d2; }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #1565c0; }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        code {
            background: #eceff1;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Detailed Push Notification Debugger</h1>
    
    <div class="test-section">
        <h2>Browser & Environment Info</h2>
        <div id="browser-info"></div>
    </div>

    <div class="test-section">
        <h2>Step-by-Step Push Registration Test</h2>
        <button onclick="runDetailedTest()">Run Detailed Test</button>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>Alternative Registration Methods</h2>
        <button onclick="testWithoutVapid()">Test Without VAPID</button>
        <button onclick="testWithDifferentVapid()">Test With Different VAPID</button>
        <button onclick="checkExistingSubscription()">Check Existing Subscription</button>
        <div id="alt-results"></div>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <pre id="console"></pre>
    </div>

    <script>
        const consoleEl = document.getElementById('console');
        const log = (msg, type = 'info') => {
            const timestamp = new Date().toISOString();
            const color = {
                error: '#f44336',
                success: '#4caf50',
                warning: '#ff9800',
                info: '#2196f3'
            }[type] || '#666';
            
            consoleEl.innerHTML += `<span style="color: ${color}">[${timestamp}] ${msg}</span>\n`;
            console.log(`[${type.toUpperCase()}]`, msg);
        };

        // Browser info
        const browserInfo = document.getElementById('browser-info');
        const ua = navigator.userAgent;
        let browserName = 'Unknown';
        
        if (ua.includes('Chrome')) browserName = 'Chrome';
        else if (ua.includes('Firefox')) browserName = 'Firefox';
        else if (ua.includes('Safari')) browserName = 'Safari';
        else if (ua.includes('Edge')) browserName = 'Edge';
        
        browserInfo.innerHTML = `
            <p><strong>Browser:</strong> ${browserName}</p>
            <p><strong>User Agent:</strong> <code>${ua}</code></p>
            <p><strong>Service Worker:</strong> ${'serviceWorker' in navigator ? '<span class="success">Supported</span>' : '<span class="error">Not Supported</span>'}</p>
            <p><strong>Push API:</strong> ${'PushManager' in window ? '<span class="success">Supported</span>' : '<span class="error">Not Supported</span>'}</p>
            <p><strong>Notification API:</strong> ${'Notification' in window ? '<span class="success">Supported</span>' : '<span class="error">Not Supported</span>'}</p>
            <p><strong>Current Permission:</strong> <code>${Notification.permission}</code></p>
            <p><strong>Protocol:</strong> <code>${location.protocol}</code></p>
            <p><strong>Hostname:</strong> <code>${location.hostname}</code></p>
        `;

        async function runDetailedTest() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h3>Running Detailed Test...</h3>';
            
            try {
                // Step 1: Check existing registrations
                results.innerHTML += '<div class="step">Step 1: Checking existing service workers...</div>';
                const existingRegs = await navigator.serviceWorker.getRegistrations();
                log(`Found ${existingRegs.length} existing service worker(s)`);
                
                // Unregister all existing ones
                for (const reg of existingRegs) {
                    await reg.unregister();
                    log(`Unregistered SW at scope: ${reg.scope}`);
                }
                
                // Step 2: Register fresh SW
                results.innerHTML += '<div class="step">Step 2: Registering fresh service worker...</div>';
                const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                log('Service worker registered', 'success');
                
                // Wait for it to be ready
                await navigator.serviceWorker.ready;
                log('Service worker is ready', 'success');
                
                // Step 3: Check push manager
                results.innerHTML += '<div class="step">Step 3: Checking PushManager...</div>';
                if (!registration.pushManager) {
                    throw new Error('PushManager not available on registration');
                }
                log('PushManager is available', 'success');
                
                // Step 4: Check current subscription
                results.innerHTML += '<div class="step">Step 4: Checking current subscription...</div>';
                const existingSub = await registration.pushManager.getSubscription();
                if (existingSub) {
                    log('Found existing subscription, unsubscribing...', 'warning');
                    await existingSub.unsubscribe();
                }
                
                // Step 5: Request permission if needed
                results.innerHTML += '<div class="step">Step 5: Checking notification permission...</div>';
                if (Notification.permission !== 'granted') {
                    const perm = await Notification.requestPermission();
                    if (perm !== 'granted') {
                        throw new Error('Permission denied by user');
                    }
                }
                log('Permission granted', 'success');
                
                // Step 6: Try to subscribe
                results.innerHTML += '<div class="step">Step 6: Attempting to subscribe...</div>';
                const vapidKey = 'BGv2Vm45eFGslcXFhakD-euIXAnOg6-bdqVWHoSw4gwvjvYYV1zBA_Q7uiNij5yvRqMwmDhpBYYSA1v5Z_GEv_k';
                
                try {
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(vapidKey)
                    });
                    
                    log('Subscription successful!', 'success');
                    results.innerHTML += `<div class="step success">✅ SUCCESS! Subscription created</div>`;
                    results.innerHTML += `<pre>${JSON.stringify(subscription.toJSON(), null, 2)}</pre>`;
                    
                } catch (subError) {
                    log(`Subscription error: ${subError.message}`, 'error');
                    results.innerHTML += `<div class="step error">❌ Subscription failed: ${subError.message}</div>`;
                    
                    // Try to get more details
                    if (subError.message.includes('push service error')) {
                        results.innerHTML += `
                            <div class="step warning">
                                <h4>Push Service Error - Possible Causes:</h4>
                                <ul>
                                    <li>Browser's push service is unavailable</li>
                                    <li>Network connectivity issues</li>
                                    <li>Corporate firewall blocking push services</li>
                                    <li>Browser extensions interfering</li>
                                    <li>Incognito/Private mode restrictions</li>
                                </ul>
                                <h4>Try these solutions:</h4>
                                <ul>
                                    <li>Check if you're behind a corporate firewall</li>
                                    <li>Try in a regular (non-incognito) window</li>
                                    <li>Disable ad blockers and privacy extensions</li>
                                    <li>Check browser console for more errors</li>
                                    <li>Try a different network (mobile hotspot)</li>
                                </ul>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                log(`Test failed: ${error.message}`, 'error');
                results.innerHTML += `<div class="step error">❌ Test failed: ${error.message}</div>`;
            }
        }

        async function testWithoutVapid() {
            const results = document.getElementById('alt-results');
            results.innerHTML = '<h3>Testing without VAPID key...</h3>';
            
            try {
                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.subscribe({
                    userVisibleOnly: true
                });
                
                results.innerHTML += '<div class="success">✅ Subscription without VAPID succeeded!</div>';
                results.innerHTML += `<pre>${JSON.stringify(sub.toJSON(), null, 2)}</pre>`;
                
            } catch (error) {
                results.innerHTML += `<div class="error">❌ Failed: ${error.message}</div>`;
            }
        }

        async function testWithDifferentVapid() {
            const results = document.getElementById('alt-results');
            results.innerHTML = '<h3>Testing with different VAPID key...</h3>';
            
            // Generate a different valid VAPID key for testing
            const testVapidKey = 'BDlgMu0J7txqpJYZgKSiDiGQqYBC3zJBMdCrKvLDwHYUFmB_lZi6W3kMx2JDpEHNKjEDAXO2DOqnQzLqskPecOY';
            
            try {
                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(testVapidKey)
                });
                
                results.innerHTML += '<div class="success">✅ Subscription with test VAPID succeeded!</div>';
                results.innerHTML += `<pre>${JSON.stringify(sub.toJSON(), null, 2)}</pre>`;
                
            } catch (error) {
                results.innerHTML += `<div class="error">❌ Failed: ${error.message}</div>`;
            }
        }

        async function checkExistingSubscription() {
            const results = document.getElementById('alt-results');
            results.innerHTML = '<h3>Checking for existing subscription...</h3>';
            
            try {
                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.getSubscription();
                
                if (sub) {
                    results.innerHTML += '<div class="success">✅ Found existing subscription:</div>';
                    results.innerHTML += `<pre>${JSON.stringify(sub.toJSON(), null, 2)}</pre>`;
                    results.innerHTML += '<button onclick="unsubscribeExisting()">Unsubscribe</button>';
                } else {
                    results.innerHTML += '<div class="info">No existing subscription found</div>';
                }
                
            } catch (error) {
                results.innerHTML += `<div class="error">❌ Error: ${error.message}</div>`;
            }
        }

        async function unsubscribeExisting() {
            try {
                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.getSubscription();
                if (sub) {
                    await sub.unsubscribe();
                    log('Unsubscribed successfully', 'success');
                    checkExistingSubscription();
                }
            } catch (error) {
                log(`Unsubscribe error: ${error.message}`, 'error');
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Auto-check on load
        log('Page loaded, ready for testing');
    </script>
</body>
</html>
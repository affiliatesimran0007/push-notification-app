<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Domain Push Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Real Domain Push Testing</h1>
        <p>Test push notifications between your domain and the push platform</p>
        
        <div class="section">
            <h2>Step 1: Configure Your Domain</h2>
            <label>Your Domain URL (with https://):</label>
            <input type="url" id="domain-url" placeholder="https://yourdomain.com" value="">
            <button onclick="generateCode()">Generate Integration Code</button>
            
            <div id="integration-code" style="display:none;">
                <h3>Integration Code for Your Domain:</h3>
                <div class="code-block" id="code-output"></div>
                <button onclick="copyCode()">Copy Code</button>
                <p class="info status">Add this code to your domain's HTML, just before the closing &lt;/body&gt; tag</p>
            </div>
        </div>
        
        <div class="section">
            <h2>Step 2: Test Push Platform Connection</h2>
            <p>Enter your push platform URL (use ngrok for HTTPS tunnel to localhost):</p>
            <input type="url" id="platform-url" placeholder="https://abc123.ngrok.io" value="http://localhost:3000">
            <button onclick="testConnection()">Test Connection</button>
            <div id="connection-status"></div>
        </div>
        
        <div class="section">
            <h2>Step 3: Manual Subscription Test</h2>
            <p>Create a test subscription on this page:</p>
            <button onclick="requestPermission()">1. Request Permission</button>
            <button onclick="registerSW()" disabled id="register-btn">2. Register Service Worker</button>
            <button onclick="createSubscription()" disabled id="subscribe-btn">3. Create Subscription</button>
            <button onclick="sendTestPush()" disabled id="test-btn">4. Send Test Push</button>
            <div id="test-status"></div>
        </div>
        
        <div class="section">
            <h2>Step 4: Verify Your Domain Setup</h2>
            <p>Check these requirements:</p>
            <ul>
                <li>‚úÖ Domain uses HTTPS</li>
                <li>‚úÖ push-sw.js is hosted at: <code>https://yourdomain.com/push-sw.js</code></li>
                <li>‚úÖ Integration code is added to your HTML</li>
                <li>‚úÖ Push platform is accessible (localhost via ngrok or deployed)</li>
            </ul>
        </div>
    </div>
    
    <script>
        let currentSubscription = null;
        
        function generateCode() {
            const domainUrl = document.getElementById('domain-url').value;
            if (!domainUrl) {
                alert('Please enter your domain URL');
                return;
            }
            
            const domain = domainUrl.replace('https://', '').replace('http://', '').split('/')[0];
            const platformUrl = document.getElementById('platform-url').value || 'https://your-push-platform.com';
            
            const code = `<!-- Push Notification Integration Code -->
<script>
(function() {
  const pushConfig = {
    appUrl: '${platformUrl}',
    landingId: 'testt',
    vapidKey: 'BGv2Vm45eFGslcXFhakD-euIXAnOg6-bdqVWHoSw4gwvjvYYV1zBA_Q7uiNij5yvRqMwmDhpBYYSA1v5Z_GEv_k',
    botCheck: true,
    redirects: {
      allow: '${domainUrl}/thank-you',
      block: '${domainUrl}/notifications'
    }
  };
  
  const script = document.createElement('script');
  script.src = pushConfig.appUrl + '/js/push-widget.js';
  script.async = true;
  script.onload = function() {
    if (window.PushWidget) {
      window.PushWidget.init(pushConfig);
    }
  };
  document.head.appendChild(script);
})();
<\/script>`;
            
            document.getElementById('code-output').textContent = code;
            document.getElementById('integration-code').style.display = 'block';
        }
        
        function copyCode() {
            const code = document.getElementById('code-output').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            });
        }
        
        async function testConnection() {
            const platformUrl = document.getElementById('platform-url').value;
            const status = document.getElementById('connection-status');
            
            try {
                status.innerHTML = '<div class="info status">Testing connection...</div>';
                
                const response = await fetch(platformUrl + '/api/clients');
                if (response.ok) {
                    status.innerHTML = '<div class="success status">‚úÖ Connection successful! Platform is accessible.</div>';
                } else {
                    status.innerHTML = '<div class="error status">‚ùå Connection failed. Status: ' + response.status + '</div>';
                }
            } catch (error) {
                status.innerHTML = '<div class="error status">‚ùå Connection failed. Make sure the URL is correct and accessible.<br>' + error.message + '</div>';
            }
        }
        
        async function requestPermission() {
            const status = document.getElementById('test-status');
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    status.innerHTML = '<div class="success status">‚úÖ Permission granted</div>';
                    document.getElementById('register-btn').disabled = false;
                } else {
                    status.innerHTML = '<div class="error status">‚ùå Permission denied</div>';
                }
            } catch (error) {
                status.innerHTML = '<div class="error status">Error: ' + error.message + '</div>';
            }
        }
        
        async function registerSW() {
            const status = document.getElementById('test-status');
            try {
                status.innerHTML = '<div class="info status">Registering service worker...</div>';
                
                const registration = await navigator.serviceWorker.register('/push-sw.js');
                await navigator.serviceWorker.ready;
                
                status.innerHTML = '<div class="success status">‚úÖ Service worker registered</div>';
                document.getElementById('subscribe-btn').disabled = false;
            } catch (error) {
                status.innerHTML = '<div class="error status">‚ùå Service worker registration failed: ' + error.message + '</div>';
            }
        }
        
        async function createSubscription() {
            const status = document.getElementById('test-status');
            try {
                status.innerHTML = '<div class="info status">Creating push subscription...</div>';
                
                const registration = await navigator.serviceWorker.ready;
                const vapidKey = 'BGv2Vm45eFGslcXFhakD-euIXAnOg6-bdqVWHoSw4gwvjvYYV1zBA_Q7uiNij5yvRqMwmDhpBYYSA1v5Z_GEv_k';
                
                currentSubscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidKey)
                });
                
                status.innerHTML = '<div class="success status">‚úÖ Push subscription created<br>Endpoint: ' + 
                    currentSubscription.endpoint.substring(0, 50) + '...</div>';
                
                // Save to platform
                await saveSubscription();
                
                document.getElementById('test-btn').disabled = false;
            } catch (error) {
                status.innerHTML = '<div class="error status">‚ùå Subscription failed: ' + error.message + '</div>';
            }
        }
        
        async function saveSubscription() {
            const platformUrl = document.getElementById('platform-url').value;
            
            try {
                const response = await fetch(platformUrl + '/api/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription: currentSubscription.toJSON(),
                        landingId: 'test-real-domain',
                        domain: window.location.hostname,
                        url: window.location.href,
                        accessStatus: 'allowed',
                        browserInfo: {
                            browser: 'Chrome',
                            version: '120',
                            os: 'Windows',
                            device: 'desktop',
                            language: navigator.language,
                            platform: navigator.platform
                        },
                        location: {
                            country: 'United States',
                            city: 'Test City',
                            ip: '127.0.0.1'
                        }
                    })
                });
                
                if (response.ok) {
                    console.log('Subscription saved to platform');
                }
            } catch (error) {
                console.error('Failed to save subscription:', error);
            }
        }
        
        async function sendTestPush() {
            const status = document.getElementById('test-status');
            const platformUrl = document.getElementById('platform-url').value;
            
            try {
                status.innerHTML = '<div class="info status">Sending test push...</div>';
                
                const response = await fetch(platformUrl + '/api/test-push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription: currentSubscription.toJSON()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    status.innerHTML = '<div class="success status">‚úÖ Test push sent! Check your notifications.</div>';
                } else {
                    status.innerHTML = '<div class="error status">‚ùå Push failed: ' + (result.message || result.error) + '</div>';
                }
            } catch (error) {
                status.innerHTML = '<div class="error status">‚ùå Error: ' + error.message + '</div>';
            }
        }
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
    </script>
</body>
</html>